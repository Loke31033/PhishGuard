<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>PhishGuard SOC Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { font-family: Arial,sans-serif; background:#f4f4f4; margin:0; padding:20px; }
h1 { text-align:center; }
form { text-align:center; margin:20px 0; }
input[type="file"], button { margin-right:10px; padding:5px; }
table { width:100%; border-collapse:collapse; margin-top:20px; background:#fff; }
th, td { padding:10px; border:1px solid #ddd; text-align:left; vertical-align:top; }
th { background:#333; color:#fff; }
tr:nth-child(even) { background:#f9f9f9; }
tr.risk-safe { background:#c8e6c9; }
tr.risk-suspicious { background:#ffe0b2; }
tr.risk-high { background:#ffcdd2; }
#liveDashboard { display:flex; justify-content:center; gap:20px; margin-bottom:20px; flex-wrap:wrap; }
#liveDashboard div { padding:10px 20px; border-radius:8px; border:1px solid #ddd; text-align:center; background:#fff; min-width:120px; }
#chartContainer, #barChartContainer { width:400px; margin:0 auto 20px auto; }
</style>
</head>
<body>
<h1>PhishGuard SOC Dashboard</h1>

<div id="liveDashboard">
  <div>Total Emails<br><span id="totalEmails">0</span></div>
  <div style="background:#c8e6c9;">Safe Emails<br><span id="safeCount">0</span></div>
  <div style="background:#ffe0b2;">Suspicious Emails<br><span id="suspiciousCount">0</span></div>
  <div style="background:#ffcdd2;">High Risk Emails<br><span id="highCount">0</span></div>
</div>

<div id="chartContainer"><canvas id="riskChart"></canvas></div>
<div id="barChartContainer"><canvas id="riskBarChart"></canvas></div>

<form id="uploadForm">
  <input type="file" id="emlFiles" accept=".eml" multiple>
  <button type="button" onclick="uploadEmails()">Upload & Analyze</button>
</form>

<div style="text-align:center; margin-bottom:10px;">
  <input type="text" id="searchInput" placeholder="Search by From or Subject">
  <select id="riskFilter">
    <option value="">Filter by Risk Level</option>
    <option value="Safe">Safe</option>
    <option value="Suspicious">Suspicious</option>
    <option value="High">High</option>
  </select>
</div>

<table id="emailsTable" aria-live="polite">
  <thead>
    <tr>
      <th>#</th><th>From</th><th>Subject</th><th>SPF</th><th>DKIM</th><th>DMARC</th><th>Risk Level</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
let emailsData = [];

function classifyRisk(spf, dkim, dmarc){
  let score = 0;
  if(spf==='fail') score+=30;
  if(dkim==='fail') score+=30;
  if(dmarc==='fail') score+=20;
  return score>=50?'High':score>=20?'Suspicious':'Safe';
}

function addEmailToTable(idx,email){
  const tbody = document.querySelector('#emailsTable tbody');
  const tr = document.createElement('tr');
  tr.className = 'risk-'+email.risk_level.toLowerCase();
  tr.innerHTML = `
    <td>${idx+1}</td>
    <td>${email.from}</td>
    <td>${email.subject||''}</td>
    <td>${email.spf}</td>
    <td>${email.dkim}</td>
    <td>${email.dmarc}</td>
    <td>${email.risk_level}</td>`;
  tbody.appendChild(tr);
}

function updateDashboard(){
  const total = emailsData.length;
  const safe = emailsData.filter(e=>e.risk_level==='Safe').length;
  const suspicious = emailsData.filter(e=>e.risk_level==='Suspicious').length;
  const high = emailsData.filter(e=>e.risk_level==='High').length;
  document.getElementById('totalEmails').textContent = total;
  document.getElementById('safeCount').textContent = safe;
  document.getElementById('suspiciousCount').textContent = suspicious;
  document.getElementById('highCount').textContent = high;
}

let riskChart, riskBarChart;
function renderCharts(){
  const labels = ['Safe','Suspicious','High'];
  const counts = [emailsData.filter(e=>e.risk_level==='Safe').length,
                  emailsData.filter(e=>e.risk_level==='Suspicious').length,
                  emailsData.filter(e=>e.risk_level==='High').length];
  if(riskChart) riskChart.destroy();
  if(riskBarChart) riskBarChart.destroy();

  const ctx = document.getElementById('riskChart').getContext('2d');
  riskChart = new Chart(ctx, {type:'pie', data:{labels, datasets:[{data:counts, backgroundColor:['#28a745','#ff9800','#dc3545']}]}});

  const ctx2 = document.getElementById('riskBarChart').getContext('2d');
  riskBarChart = new Chart(ctx2, {type:'bar', data:{labels, datasets:[{label:'Emails', data:counts, backgroundColor:['#28a745','#ff9800','#dc3545']}]}, options:{responsive:true}});
}

async function uploadEmails(){
  const files = document.getElementById('emlFiles').files;
  if(!files.length){ alert('Select files'); return; }
  emailsData=[]; document.querySelector('#emailsTable tbody').innerHTML='';

  for(let i=0;i<files.length;i++){
    const formData = new FormData();
    formData.append('email', files[i]);
    try{
      const resp = await fetch('/upload',{method:'POST', body:formData});
      const data = await resp.json();
      
      // SAFE DATA ACCESS - FIXED THE ERROR
      const authData = data.spf_dkim_dmarc || {};
      const spf = authData.spf || 'fail';
      const dkim = authData.dkim || 'fail';
      const dmarc = authData.dmarc || 'fail';
      
      const risk_level = classifyRisk(spf, dkim, dmarc);
      const emailObj = {
        from: data.from || '',
        subject: data.headers?.Subject || '',
        spf: spf,
        dkim: dkim,
        dmarc: dmarc,
        risk_level
      };
      emailsData.push(emailObj);
      addEmailToTable(i,emailObj);
    }catch(err){ 
      console.error("Upload error:", err); 
      alert('Error uploading file: ' + err.message); 
    }
  }

  updateDashboard();
  renderCharts();
}

// =================== Search & Filter ===================
document.getElementById('searchInput').oninput = document.getElementById('riskFilter').onchange = function(){
  const query = document.getElementById('searchInput').value.toLowerCase();
  const filter = document.getElementById('riskFilter').value;
  const tbody = document.querySelector('#emailsTable tbody');
  tbody.innerHTML='';
  emailsData.forEach((e,i)=>{
    if((e.from.toLowerCase().includes(query)|| (e.subject||'').toLowerCase().includes(query)) &&
       (filter==='' || e.risk_level===filter)){
      addEmailToTable(i,e);
    }
  });
};
</script>
</body>
</html>
